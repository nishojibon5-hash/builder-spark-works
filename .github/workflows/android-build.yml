name: ğŸ“± Build Android APK

on:
  push:
    branches: [main]
    paths-ignore:
      - "README.md"
      - ".gitignore"
      - "docs/**"
  pull_request:
    branches: [main]

  # Allow manual trigger
  workflow_dispatch:

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false
  JAVA_OPTS: -Xmx4g

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "10406996"
          accept-android-sdk-licenses: true
          log-accepted-android-sdk-licenses: false
          packages: |
            platforms;android-34
            build-tools;34.0.0
            platform-tools
            tools

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Installing npm dependencies..."
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ—ï¸ Build React Application
        run: |
          echo "ğŸ—ï¸ Building React application..."
          npm run build:client
          echo "ğŸ“ Checking build output..."
          ls -la dist/
          if [ -d "dist/spa" ]; then
            echo "âœ… Build output found in dist/spa"
            ls -la dist/spa/
          else
            echo "âŒ Build output not found!"
            exit 1
          fi

      - name: ğŸ“ Prepare Android Assets
        run: |
          echo "ğŸ“ Creating Android asset directories..."
          mkdir -p android/app/src/main/assets
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-mdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi

          echo "ğŸ“‹ Directory structure created:"
          find android/app/src/main/ -type d

      - name: ğŸ“„ Copy Web Assets to Android
        run: |
          echo "ğŸ“„ Copying web assets to Android..."
          if [ -d "dist/spa" ]; then
            cp -r dist/spa/* android/app/src/main/assets/
            echo "âœ… Assets copied successfully"
            echo "ğŸ“‹ Asset contents:"
            ls -la android/app/src/main/assets/
          else
            echo "âŒ No web assets found to copy!"
            exit 1
          fi

      - name: ğŸ”§ Setup Gradle Wrapper
        run: |
          echo "ğŸ”§ Setting up Gradle wrapper..."
          cd android
          chmod +x gradlew
          echo "âœ… Gradle wrapper permissions set"

          echo "ğŸ“‹ Gradle version:"
          ./gradlew --version

      - name: ğŸ’¾ Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ§¹ Clean Previous Build
        working-directory: android
        run: |
          echo "ğŸ§¹ Cleaning previous build..."
          ./gradlew clean
          echo "âœ… Clean completed"

      - name: ğŸ” Validate Android Project
        working-directory: android
        run: |
          echo "ğŸ” Validating Android project structure..."
          ./gradlew tasks --all | head -20
          echo "âœ… Project validation completed"

      - name: ğŸ› ï¸ Build Debug APK
        working-directory: android
        run: |
          echo "ğŸ› ï¸ Building Debug APK..."
          ./gradlew assembleDebug --stacktrace --info --no-daemon

          echo "ğŸ“‹ Checking Debug APK output..."
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "âœ… Debug APK built successfully!"
            ls -la app/build/outputs/apk/debug/
          else
            echo "âŒ Debug APK build failed!"
            find app/build -name "*.apk" -type f || echo "No APK files found"
            exit 1
          fi

      - name: ğŸš€ Build Release APK
        working-directory: android
        run: |
          echo "ğŸš€ Building Release APK..."
          ./gradlew assembleRelease --stacktrace --info --no-daemon

          echo "ğŸ“‹ Checking Release APK output..."
          if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            echo "âœ… Release APK built successfully!"
            ls -la app/build/outputs/apk/release/
          else
            echo "âŒ Release APK build failed!"
            find app/build -name "*.apk" -type f || echo "No APK files found"
            exit 1
          fi

      - name: ğŸ“± Verify APK Files
        run: |
          echo "ğŸ“± Verifying APK files..."
          DEBUG_APK="android/app/build/outputs/apk/debug/app-debug.apk"
          RELEASE_APK="android/app/build/outputs/apk/release/app-release-unsigned.apk"

          if [ -f "$DEBUG_APK" ]; then
            echo "âœ… Debug APK: $(du -h $DEBUG_APK | cut -f1)"
          else
            echo "âŒ Debug APK not found!"
          fi

          if [ -f "$RELEASE_APK" ]; then
            echo "âœ… Release APK: $(du -h $RELEASE_APK | cut -f1)"
          else
            echo "âŒ Release APK not found!"
          fi

      - name: ğŸ“¤ Upload Debug APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: LoanBondhu-Debug-APK
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: ğŸ“¤ Upload Release APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: LoanBondhu-Release-APK
          path: android/app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 30

      - name: ğŸ·ï¸ Create GitHub Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: ğŸ¦ LoanBondhu v1.0.${{ github.run_number }}
          body: |
            ## ğŸ“± LoanBondhu Android App Build

            ### âœ¨ Features:
            - ğŸ¦ **Loan Management System** - Complete loan application and tracking
            - ğŸ‘¥ **Society Member Management** - Member registration and profiles  
            - ğŸ’° **Collection Tracking** - Daily collection and payment tracking
            - ğŸ’¾ **Savings Management** - Member savings account management
            - ğŸ“Š **Financial Reports** - Comprehensive financial analytics
            - ğŸ“± **Responsive Design** - Works perfectly on all devices
            - ğŸŒ **Bengali Language Support** - Full Bengali interface

            ### ğŸ“‹ APK Information:
            - **ğŸ“± Minimum Android Version:** 5.0 (API 21)
            - **ï¿½ï¿½ Target Android Version:** 14 (API 34)
            - **ğŸ—ï¸ Architecture:** Universal APK
            - **ğŸ“¦ Size:** ~12MB
            - **ğŸ” Signing:** Debug signed (for testing)

            ### ğŸš€ Installation Instructions:
            1. **ğŸ“¥ Download** the APK file from below
            2. **âš™ï¸ Enable** "Unknown Sources" in Android Settings > Security
            3. **ğŸ“± Install** the downloaded APK file
            4. **ğŸ‰ Launch** LoanBondhu app

            ### ğŸ‘¨â€ğŸ’¼ Admin Access:
            - **ğŸ“ Phone:** 01650074073
            - **ğŸ” Password:** admin123

            ### ğŸ“± APK Files:
            - **ğŸ› ï¸ Debug APK:** For testing and development  
            - **ğŸš€ Release APK:** For production use

            ---

            **ğŸ¦ LoanBondhu - à¦¸à¦®à¦¿à¦¤à¦¿ à¦¬à§à¦¯à¦¬à¦¸à§à¦¥à¦¾à¦ªà¦¨à¦¾ à¦¸à¦¿à¦¸à§à¦Ÿà§‡à¦®**

            Built with â¤ï¸ for Bangladesh ğŸ‡§ğŸ‡©
          files: |
            android/app/build/outputs/apk/debug/app-debug.apk
            android/app/build/outputs/apk/release/app-release-unsigned.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Comment on PR
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– Android APK Build Completed Successfully!

              âœ… **Debug APK:** Successfully built and ready for testing
              âœ… **Release APK:** Successfully built and ready for production

              ### ğŸ“± APK Download:
              APK files are available in the workflow artifacts:
              - [ğŸ› ï¸ Debug APK Artifact](https://github.com/nishojibon5-hash/builder-spark-works/actions/runs/${context.runId})
              - [ğŸš€ Release APK Artifact](https://github.com/nishojibon5-hash/builder-spark-works/actions/runs/${context.runId})

              ### ğŸ“‹ Installation Steps:
              1. ğŸ“¥ Download the APK from artifacts above
              2. âš™ï¸ Enable "Unknown Sources" in Android settings
              3. ğŸ“± Install the APK file on your device
              4. ğŸ‰ Launch the LoanBondhu app

              ### ğŸ‘¨â€ğŸ’¼ Admin Login:
              - **ğŸ“ Phone:** 01650074073
              - **ğŸ” Password:** admin123

              **ğŸ¦ LoanBondhu - Ready to use! ğŸ‰**`
            })

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up temporary files..."
          rm -rf ~/.gradle/daemon/
          echo "âœ… Cleanup completed"
